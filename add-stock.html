<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Stock - Inventory Management</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .stock-option {
            background: #F7FAFC;
            border: 2px solid #E9D8FD;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 24px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .stock-option:hover {
            border-color: #9F7AEA;
            background: #FAF5FF;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(159, 122, 234, 0.15);
        }

        .stock-option.selected {
            border-color: #6B46C1;
            background: #EDF2F7;
        }

        .stock-option h3 {
            color: #553C9A;
            margin-bottom: 12px;
            font-size: 20px;
        }

        .stock-option p {
            color: #6B46C1;
            margin: 0;
            font-size: 15px;
        }

        .formulary-section, .new-drug-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-top: 24px;
            border: 1px solid #E9D8FD;
        }

        .drug-search {
            position: relative;
            margin-bottom: 20px;
        }

        .drug-search input {
            width: 100%;
            padding: 12px;
            border: 2px solid #E9D8FD;
            border-radius: 8px;
            font-size: 16px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #E9D8FD;
            border-radius: 6px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .search-result-item {
            padding: 12px;
            border-bottom: 1px solid #F1F5F9;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-result-item:hover {
            background: #FAF5FF;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .selected-drug-info {
            background: #EDF2F7;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .quantity-input-group {
            display: flex;
            gap: 12px;
            align-items: center;
            margin: 20px 0;
        }

        .quantity-input-group input {
            width: 120px;
            padding: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .force-cycle-btn {
            background: #805AD5;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-left: 12px;
        }

        .force-cycle-btn:hover {
            background: #6B46C1;
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <div class="sidebar-header">
            <h2>menu</h2>
        </div>
        <ul class="sidebar-nav">
            <li><a href="index.html">home</a></li>
            <li><a href="medidose.html">medidose labels</a></li>
            <li><a href="rxlabel.html">rx labels</a></li>
            <li><a href="inventory.html">inventory</a></li>
            <li><a href="settings.html">settings</a></li>
        </ul>
    </nav>

    <div class="main-content">
        <div class="container">
            <h1>Add Stock</h1>
            
            <div class="section">
                <a href="inventory.html" class="secondary-btn" style="margin-bottom: 20px;">‚Üê Back to Inventory</a>
                
                <h2>Select stock addition type</h2>
                
                <!-- Option Selection -->
                <div class="stock-option" onclick="selectStockType('formulary')">
                    <h3>Existing Drug on Formulary</h3>
                    <p>Add inventory for drugs already in the system</p>
                </div>
                
                <div class="stock-option" onclick="selectStockType('new-drug')">
                    <h3>New Drug Entry</h3>
                    <p>Create formulary entry for new drugs</p>
                </div>

                <!-- Formulary Drug Section -->
                <div id="formulary-section" class="formulary-section">
                    <h3>Add Inventory - Existing Drug</h3>
                    
                    <div class="drug-search">
                        <input type="text" id="drug-search" placeholder="Search by brand name, generic name, or NDC">
                        <div id="search-results" class="search-results"></div>
                    </div>

                    <div id="selected-drug-info" class="selected-drug-info">
                        <h4>Drug Information</h4>
                        <div id="drug-details"></div>
                        
                        <div class="quantity-input-group">
                            <label><strong>Quantity to Add:</strong></label>
                            <input type="number" id="add-quantity" placeholder="0" min="0" step="1">
                            <span>units</span>
                            <button type="button" class="force-cycle-btn" onclick="forceCycleCount()">
                                Use Cycle Count
                            </button>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-lot">Lot Number</label>
                                <input type="text" id="new-lot" placeholder="Leave blank to use existing">
                            </div>
                            <div class="form-group">
                                <label for="new-expiration">Expiration Date</label>
                                <input type="date" id="new-expiration" placeholder="Leave blank to use existing">
                            </div>
                        </div>

                        <button type="button" class="generate-btn" onclick="addStockToFormulary()" id="add-stock-btn" disabled>
                            Add Inventory
                        </button>
                    </div>
                </div>

                <!-- New Drug Section -->
                <div id="new-drug-section" class="new-drug-section">
                    <h3>New Drug Entry</h3>
                    <p>Add new drug to formulary with initial inventory.</p>
                    
                    <form id="new-drug-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-brand-name">Brand Name *</label>
                                <input type="text" id="new-brand-name" required>
                            </div>
                            <div class="form-group">
                                <label for="new-generic-name">Generic Name *</label>
                                <input type="text" id="new-generic-name" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-ndc">NDC *</label>
                                <input type="text" id="new-ndc" placeholder="XXXXX-XXXX-XX" required>
                            </div>
                            <div class="form-group">
                                <label for="new-strength">Strength *</label>
                                <input type="text" id="new-strength" placeholder="e.g. 200mg" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="new-dosage-form">Dosage Form *</label>
                                <select id="new-dosage-form" required>
                                    <option value="">Select dosage form</option>
                                    <option value="tablets">Tablets</option>
                                    <option value="capsules">Capsules</option>
                                    <option value="liquid">Liquid</option>
                                    <option value="injection">Injection</option>
                                    <option value="cream">Cream</option>
                                    <option value="ointment">Ointment</option>
                                    <option value="drops">Drops</option>
                                    <option value="inhaler">Inhaler</option>
                                    <option value="patches">Patches</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="new-shelf">Shelf Number *</label>
                                <select id="new-shelf" required>
                                    <option value="">Select shelf</option>
                                    <option value="1">Shelf 1</option>
                                    <option value="2">Shelf 2</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="initial-amount">Initial Stock Quantity *</label>
                                <input type="number" id="initial-amount" min="0" step="1" required>
                            </div>
                            <div class="form-group">
                                <label for="new-par-level">Par Level (Reorder Point) *</label>
                                <input type="number" id="new-par-level" min="0" step="1" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="initial-lot">Lot Number *</label>
                                <input type="text" id="initial-lot" required>
                            </div>
                            <div class="form-group">
                                <label for="initial-expiration">Expiration Date *</label>
                                <input type="date" id="initial-expiration" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="new-notes">Notes (Optional)</label>
                            <textarea id="new-notes" rows="3" placeholder="Any special storage instructions or notes..."></textarea>
                        </div>

                        <button type="submit" class="generate-btn">Add to Formulary</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-data.js"></script>
    <script src="inventory-script.js"></script>
    <script>
        let selectedDrug = null;
        let allFormularyDrugs = [];

        // Load the page
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('Loading add-stock page...');
            
            // Wait for inventory database to initialize
            let attempts = 0;
            while (!inventoryDB && attempts < 50) {
                console.log('Waiting for inventoryDB to initialize...', attempts);
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (inventoryDB) {
                console.log('InventoryDB ready, loading formulary drugs...');
                await loadFormularyDrugs();
            } else {
                console.error('InventoryDB failed to initialize after 5 seconds');
                alert('Database connection failed. Please refresh the page.');
            }
        });

        // Select stock type
        function selectStockType(type) {
            // Reset selections
            document.querySelectorAll('.stock-option').forEach(option => {
                option.classList.remove('selected');
            });
            document.querySelectorAll('.formulary-section, .new-drug-section').forEach(section => {
                section.style.display = 'none';
            });

            // Show selected type
            event.target.closest('.stock-option').classList.add('selected');
            
            if (type === 'formulary') {
                document.getElementById('formulary-section').style.display = 'block';
                document.getElementById('drug-search').focus();
            } else if (type === 'new-drug') {
                document.getElementById('new-drug-section').style.display = 'block';
                document.getElementById('new-brand-name').focus();
            }
        }

        // Load all formulary drugs
        async function loadFormularyDrugs() {
            try {
                console.log('Loading formulary drugs...');
                if (!inventoryDB) {
                    throw new Error('InventoryDB not initialized');
                }
                
                allFormularyDrugs = await inventoryDB.getAllInventory(200); // Get all drugs
                console.log(`Loaded ${allFormularyDrugs.length} formulary drugs:`, allFormularyDrugs);
                
                // Show some debug info about what drugs we have
                if (allFormularyDrugs.length > 0) {
                    console.log('Sample drugs:', allFormularyDrugs.slice(0, 3).map(d => ({ 
                        brand: d.brandName, 
                        generic: d.genericName, 
                        ndc: d.ndc 
                    })));
                }
            } catch (error) {
                console.error('Error loading formulary drugs:', error);
                alert('Failed to load formulary drugs. Please refresh the page.');
            }
        }

        // Search formulary drugs
        document.getElementById('drug-search').addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();
            const resultsDiv = document.getElementById('search-results');
            
            console.log('Searching for:', query);
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }

            if (!allFormularyDrugs || allFormularyDrugs.length === 0) {
                resultsDiv.innerHTML = '<div class="search-result-item">No formulary drugs loaded yet. Please wait...</div>';
                resultsDiv.style.display = 'block';
                return;
            }

            const matches = allFormularyDrugs.filter(drug => {
                const brandMatch = drug.brandName && drug.brandName.toLowerCase().includes(query);
                const genericMatch = drug.genericName && drug.genericName.toLowerCase().includes(query);
                const ndcMatch = drug.ndc && drug.ndc.toLowerCase().includes(query);
                
                const isMatch = brandMatch || genericMatch || ndcMatch;
                
                if (isMatch) {
                    console.log('Found match:', { brand: drug.brandName, generic: drug.genericName, ndc: drug.ndc });
                }
                
                return isMatch;
            });

            console.log(`Found ${matches.length} matches out of ${allFormularyDrugs.length} total drugs`);
            displaySearchResults(matches);
        });

        // Display search results
        function displaySearchResults(drugs) {
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = '';

            if (drugs.length === 0) {
                resultsDiv.innerHTML = '<div class="search-result-item">No matching drugs found</div>';
            } else {
                drugs.forEach(drug => {
                    const div = document.createElement('div');
                    div.className = 'search-result-item';
                    div.innerHTML = `
                        <strong>${drug.brandName}</strong> (${drug.genericName})<br>
                        <small>NDC: ${drug.ndc} | Current Stock: ${drug.amount || 0} | Shelf: ${drug.shelfNumber}</small>
                    `;
                    div.onclick = () => selectDrug(drug);
                    resultsDiv.appendChild(div);
                });
            }

            resultsDiv.style.display = 'block';
        }

        // Select a drug from search
        function selectDrug(drug) {
            selectedDrug = drug;
            document.getElementById('search-results').style.display = 'none';
            document.getElementById('drug-search').value = `${drug.brandName} (${drug.genericName})`;
            
            // Show drug details
            const detailsDiv = document.getElementById('drug-details');
            detailsDiv.innerHTML = `
                <p><strong>Brand:</strong> ${drug.brandName}</p>
                <p><strong>Generic:</strong> ${drug.genericName}</p>
                <p><strong>NDC:</strong> ${drug.ndc}</p>
                <p><strong>Strength:</strong> ${drug.strength || 'Not specified'}</p>
                <p><strong>Current Stock:</strong> ${drug.amount || 0} units</p>
                <p><strong>Par Level:</strong> ${drug.parLevel || 0} units</p>
                <p><strong>Shelf:</strong> ${drug.shelfNumber}</p>
                <p><strong>Current Lot:</strong> ${drug.lot || 'N/A'}</p>
                <p><strong>Current Expiration:</strong> ${drug.expiration || 'N/A'}</p>
            `;
            
            document.getElementById('selected-drug-info').style.display = 'block';
            document.getElementById('add-stock-btn').disabled = false;
            document.getElementById('add-quantity').focus();
        }

        // Add stock to existing formulary drug
        async function addStockToFormulary() {
            if (!selectedDrug) {
                alert('Please select a drug first');
                return;
            }

            const addQuantity = parseInt(document.getElementById('add-quantity').value);
            if (!addQuantity || addQuantity <= 0) {
                alert('Please enter a valid quantity to add');
                return;
            }

            const newLot = document.getElementById('new-lot').value || selectedDrug.lot;
            const newExpiration = document.getElementById('new-expiration').value || selectedDrug.expiration;

            try {
                const newAmount = (selectedDrug.amount || 0) + addQuantity;
                
                await inventoryDB.updateInventoryItem(selectedDrug.id, {
                    amount: newAmount,
                    lot: newLot,
                    expiration: newExpiration,
                    updatedAt: new Date().toISOString()
                });

                // Log the transaction
                await db.collection('inventory_transactions').add({
                    drugId: selectedDrug.id,
                    brandName: selectedDrug.brandName,
                    transactionType: 'stock_addition',
                    quantityAdded: addQuantity,
                    previousAmount: selectedDrug.amount || 0,
                    newAmount: newAmount,
                    timestamp: new Date().toISOString(),
                    lot: newLot,
                    expiration: newExpiration
                });

                alert(`Successfully added ${addQuantity} units to ${selectedDrug.brandName}`);
                window.location.href = 'inventory.html';
                
            } catch (error) {
                console.error('Error adding stock:', error);
                alert('Error adding stock: ' + error.message);
            }
        }

        // Force cycle count for discrepancy correction
        function forceCycleCount() {
            if (!selectedDrug) {
                alert('Please select a drug first');
                return;
            }
            
            // Redirect to cycle count page with this drug pre-selected
            window.location.href = `cycle-count.html?drug=${selectedDrug.id}`;
        }

        // Handle new drug form submission
        document.getElementById('new-drug-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Adding...';
            submitBtn.disabled = true;

            try {
                const newDrug = {
                    brandName: document.getElementById('new-brand-name').value,
                    genericName: document.getElementById('new-generic-name').value,
                    ndc: document.getElementById('new-ndc').value,
                    strength: document.getElementById('new-strength').value,
                    dosageForm: document.getElementById('new-dosage-form').value,
                    shelfNumber: document.getElementById('new-shelf').value,
                    amount: parseInt(document.getElementById('initial-amount').value),
                    parLevel: parseInt(document.getElementById('new-par-level').value),
                    lot: document.getElementById('initial-lot').value,
                    expiration: document.getElementById('initial-expiration').value,
                    notes: document.getElementById('new-notes').value
                };

                const result = await inventoryDB.addInventoryItem(newDrug);

                // Log the transaction
                await db.collection('inventory_transactions').add({
                    drugId: result.id,
                    brandName: newDrug.brandName,
                    transactionType: 'new_drug_addition',
                    quantityAdded: newDrug.amount,
                    previousAmount: 0,
                    newAmount: newDrug.amount,
                    timestamp: new Date().toISOString(),
                    lot: newDrug.lot,
                    expiration: newDrug.expiration
                });

                alert(`Successfully added ${newDrug.brandName} to formulary with ${newDrug.amount} units`);
                window.location.href = 'inventory.html';

            } catch (error) {
                console.error('Error adding new drug:', error);
                alert('Error adding new drug: ' + error.message);
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Hide search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.drug-search')) {
                document.getElementById('search-results').style.display = 'none';
            }
        });
    </script>
    <script src="footer.js"></script>
</body>
</html>